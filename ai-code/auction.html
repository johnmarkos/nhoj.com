<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PHDC Silent Auction Manager</title>
    <style>
        :root {
            --primary: #330066;
            --primary-light: #5c3d99;
            --primary-dark: #220044;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --text: #333;
            --text-light: #666;
            --border: #ddd;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
        }
        * { box-sizing: border-box; }
        body {
            background-color: var(--bg);
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: var(--text);
            line-height: 1.5;
        }
        header {
            background: var(--primary);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header h1 { margin: 0; font-size: 1.3rem; }
        header .event-info { font-size: 0.85rem; opacity: 0.9; }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem 2rem;
        }
        .back-link {
            display: inline-block;
            padding: 0.75rem 0;
            color: var(--primary);
            text-decoration: none;
            font-size: 0.9rem;
        }
        .back-link:hover { text-decoration: underline; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid var(--primary);
            margin-bottom: 1.5rem;
            overflow-x: auto;
        }
        .tab {
            padding: 0.75rem 1.25rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-light);
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .tab:hover { background: rgba(51, 0, 102, 0.05); }
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: 600;
        }
        .panel { display: none; }
        .panel.active { display: block; }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 1.25rem;
            margin-bottom: 1.25rem;
        }
        .card h2 {
            margin: 0 0 1rem;
            font-size: 1rem;
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 0.5rem;
        }
        .card h3 {
            margin: 1.25rem 0 0.75rem;
            font-size: 0.9rem;
            color: var(--text);
        }
        .card h3:first-child { margin-top: 0; }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        .form-group label {
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
            color: #555;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.9rem;
            font-family: inherit;
        }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(51,0,102,0.1);
        }
        .form-group .hint {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 0.2rem;
        }
        .form-row {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }
        .form-row .form-group { flex: 1; }

        /* Buttons */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            font-family: inherit;
            transition: all 0.2s;
        }
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        .btn-primary:hover { background: var(--primary-light); }
        .btn-secondary {
            background: #e9ecef;
            color: var(--text);
        }
        .btn-secondary:hover { background: #dee2e6; }
        .btn-success {
            background: var(--success);
            color: white;
        }
        .btn-success:hover { background: #218838; }
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        .btn-danger:hover { background: #c82333; }
        .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.8rem; }
        .btn-group { display: flex; gap: 0.5rem; flex-wrap: wrap; }

        /* Tables */
        .table-container { overflow-x: auto; }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        th, td {
            padding: 0.6rem 0.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        th {
            background: #f1f3f4;
            font-weight: 600;
            color: var(--text);
            position: sticky;
            top: 0;
        }
        th.sortable { cursor: pointer; }
        th.sortable:hover { background: #e8eaeb; }
        tr:hover { background: #f8f9fa; }
        .actions { white-space: nowrap; }

        /* Search/Filter */
        .toolbar {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }
        .search-box {
            flex: 1;
            min-width: 200px;
            max-width: 300px;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .search-box:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Logo preview */
        .logo-preview {
            max-width: 200px;
            max-height: 100px;
            margin-top: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 4px;
        }
        .logo-placeholder {
            width: 200px;
            height: 80px;
            border: 2px dashed var(--border);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: white;
            border-radius: 8px;
            max-width: 90%;
            max-height: 90vh;
            overflow: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .modal-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 { margin: 0; font-size: 1.1rem; }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            line-height: 1;
        }
        .modal-body { padding: 1.25rem; }
        .modal-footer {
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }
        .stat-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }
        .stat-card .label {
            font-size: 0.75rem;
            opacity: 0.9;
            text-transform: uppercase;
        }
        .stat-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 0.25rem;
        }
        .stat-card.success { background: linear-gradient(135deg, var(--success) 0%, #34ce57 100%); }
        .stat-card.warning { background: linear-gradient(135deg, #e0a800 0%, var(--warning) 100%); }

        /* Checkout item card */
        .checkout-item {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 0.75rem;
            align-items: center;
        }
        .checkout-item .lot {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            min-width: 50px;
        }
        .checkout-item .details { flex: 1; }
        .checkout-item .title { font-weight: 600; }
        .checkout-item .meta { font-size: 0.8rem; color: var(--text-light); }
        .checkout-item .bid-info { text-align: right; }
        .checkout-item.paid { background: #d4edda; }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
        }
        .empty-state .icon { font-size: 2.5rem; margin-bottom: 0.5rem; }

        /* Print styles */
        @media print {
            body { background: white; }
            header, .tabs, .back-link, .toolbar, .btn, .no-print { display: none !important; }
            .container { max-width: none; padding: 0; }
            .card { box-shadow: none; margin: 0; padding: 0; }
        }

        /* Bid sheet styles (work in preview and print) */
        .bid-sheet {
            position: relative;
            padding: 1rem;
            min-height: 400px;
        }
        .lot-corner {
            position: absolute;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        .lot-corner.top-left { top: 0.5rem; left: 0.5rem; }
        .lot-corner.top-right { top: 0.5rem; right: 0.5rem; }
        .lot-corner.bottom-left { bottom: 0.5rem; left: 0.5rem; }
        .lot-corner.bottom-right { bottom: 0.5rem; right: 0.5rem; }
        .bid-sheet-header {
            text-align: center;
            margin-bottom: 1rem;
            padding-top: 2rem;
        }
        .bid-sheet-header img {
            max-height: 60px;
            margin-bottom: 0.5rem;
        }
        .bid-sheet-header h2 {
            margin: 0;
            font-size: 1.25rem;
            color: var(--primary);
        }
        .bid-sheet-item {
            text-align: center;
            margin: 1rem 0;
        }
        .bid-sheet-item h3 {
            font-size: 1.5rem;
            margin: 0 0 0.5rem;
        }
        .bid-sheet-item .description {
            font-size: 1rem;
            color: var(--text);
            margin-bottom: 0.5rem;
        }
        .bid-sheet-item .donor {
            font-size: 0.9rem;
            font-style: italic;
            color: var(--text-light);
        }
        .bid-sheet-item .value-info {
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        .bid-table {
            width: 100%;
            max-width: 500px;
            margin: 1.5rem auto;
            border-collapse: collapse;
        }
        .bid-table th,
        .bid-table td {
            border: 1px solid #333;
            padding: 0.4rem;
            text-align: center;
        }
        .bid-table th {
            background: #f0f0f0;
        }
        .bid-sheet-footer {
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 1rem;
        }

        /* Bid sheet print mode overrides */
        body[data-print-mode="bidsheets"] .print-content {
            display: block;
        }
        body[data-print-mode="bidsheets"] .bid-sheet {
            page-break-after: always;
            padding: 0.5in;
            min-height: 100vh;
        }
        body[data-print-mode="bidsheets"] .bid-sheet:last-child {
            page-break-after: avoid;
        }
        body[data-print-mode="bidsheets"] .lot-corner.top-left { top: 0.25in; left: 0.25in; }
        body[data-print-mode="bidsheets"] .lot-corner.top-right { top: 0.25in; right: 0.25in; }
        body[data-print-mode="bidsheets"] .lot-corner.bottom-left { bottom: 0.25in; left: 0.25in; }
        body[data-print-mode="bidsheets"] .lot-corner.bottom-right { bottom: 0.25in; right: 0.25in; }
        body[data-print-mode="bidsheets"] .bid-sheet-header {
            padding-top: 0.5in;
        }
        body[data-print-mode="bidsheets"] .bid-sheet-footer {
            position: absolute;
            bottom: 0.5in;
            left: 0.5in;
            right: 0.5in;
        }

        /* Print content hidden by default */
        .print-content { display: none; }
        @media print {
            .screen-content { display: none !important; }
            .print-content { display: block !important; }
        }

        /* Category tags */
        .category-tag {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            background: #e9ecef;
            border-radius: 3px;
            font-size: 0.75rem;
            color: var(--text-light);
        }

        /* Status badges */
        .badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-info { background: #d1ecf1; color: #0c5460; }
        .badge-secondary { background: #e9ecef; color: #6c757d; }

        /* Thank you letter print */
        body[data-print-mode="thankyou"] .thank-you-letter {
            page-break-after: always;
            padding: 1in;
            font-size: 12pt;
            line-height: 1.6;
        }
        body[data-print-mode="thankyou"] .thank-you-letter:last-child {
            page-break-after: avoid;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .toolbar { flex-direction: column; align-items: stretch; }
            .search-box { max-width: none; }
        }
    </style>
</head>
<body>
    <header>
        <div>
            <h1>PHDC Silent Auction Manager</h1>
            <div class="event-info" id="headerEventInfo"></div>
        </div>
    </header>

    <div class="container screen-content">
        <a href="index.html" class="back-link">‚Üê Back to Tools</a>

        <div class="tabs">
            <button class="tab active" data-panel="setup">Setup</button>
            <button class="tab" data-panel="donors">Donors</button>
            <button class="tab" data-panel="items">Items</button>
            <button class="tab" data-panel="print">Print</button>
            <button class="tab" data-panel="checkout">Checkout</button>
            <button class="tab" data-panel="export">Export/Import</button>
        </div>

        <!-- Setup Panel -->
        <div class="panel active" id="panel-setup">
            <div class="card">
                <h2>Organization & Event Information</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="orgName">Organization Name</label>
                        <input type="text" id="orgName" placeholder="e.g., PHDC">
                    </div>
                    <div class="form-group">
                        <label for="eventName">Event Name</label>
                        <input type="text" id="eventName" placeholder="e.g., Annual Gala 2025">
                    </div>
                    <div class="form-group">
                        <label for="eventDate">Event Date</label>
                        <input type="date" id="eventDate">
                    </div>
                    <div class="form-group">
                        <label for="logoUpload">Organization Logo</label>
                        <input type="file" id="logoUpload" accept="image/*">
                        <div id="logoPreview"></div>
                        <button class="btn btn-sm btn-secondary" id="removeLogo" style="margin-top:0.5rem;display:none;">Remove Logo</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Bid Sheet Options</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="bidLineCount">Number of Bid Lines</label>
                        <input type="number" id="bidLineCount" value="15" min="5" max="30">
                        <span class="hint">Rows for bidders to write their bids</span>
                    </div>
                    <div class="form-group">
                        <label for="bidSheetFontSize">Font Size</label>
                        <select id="bidSheetFontSize">
                            <option value="small">Small</option>
                            <option value="medium" selected>Medium</option>
                            <option value="large">Large</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="showDonorOnSheet" checked>
                            Show donor name on bid sheet
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="showFmvOnSheet" checked>
                            Show fair market value
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="showBuyNowOnSheet" checked>
                            Show "Buy Now" price (if set)
                        </label>
                    </div>
                    <div class="form-group full-width">
                        <label for="bidSheetFooter">Bid Sheet Footer Text</label>
                        <input type="text" id="bidSheetFooter" placeholder="e.g., Thank you for supporting our mission!">
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Thank-You Letter Template</h2>
                <div class="form-group full-width">
                    <label for="thankYouTemplate">Letter Template</label>
                    <textarea id="thankYouTemplate" rows="10" placeholder="Enter your thank-you letter template...">Dear {DONOR_NAME},

Thank you for your generous donation to {ORG_NAME}'s {EVENT_NAME} on {EVENT_DATE}.

Your contribution(s):
{ITEM_LIST}

Your support makes a real difference in our community.

With gratitude,
{ORG_NAME}</textarea>
                    <span class="hint">Available placeholders: {DONOR_NAME}, {DONOR_BUSINESS}, {ORG_NAME}, {EVENT_NAME}, {EVENT_DATE}, {ITEM_LIST}, {TOTAL_VALUE}</span>
                </div>
            </div>

            <div class="card">
                <h2>Categories</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="newCategory">Add Category</label>
                        <input type="text" id="newCategory" placeholder="e.g., Art, Experience, Gift Card">
                    </div>
                    <button class="btn btn-primary" id="addCategoryBtn">Add</button>
                </div>
                <div id="categoryList" style="margin-top:1rem;"></div>
            </div>
        </div>

        <!-- Donors Panel -->
        <div class="panel" id="panel-donors">
            <div class="card">
                <h2>Add/Edit Donor</h2>
                <form id="donorForm">
                    <input type="hidden" id="donorId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="donorName">Contact Name *</label>
                            <input type="text" id="donorName" required>
                        </div>
                        <div class="form-group">
                            <label for="donorBusiness">Business Name</label>
                            <input type="text" id="donorBusiness">
                        </div>
                        <div class="form-group">
                            <label for="donorEmail">Email</label>
                            <input type="email" id="donorEmail">
                        </div>
                        <div class="form-group">
                            <label for="donorPhone">Phone</label>
                            <input type="tel" id="donorPhone">
                        </div>
                        <div class="form-group full-width">
                            <label for="donorAddress">Address</label>
                            <input type="text" id="donorAddress">
                        </div>
                        <div class="form-group full-width">
                            <label for="donorNotes">Notes</label>
                            <textarea id="donorNotes" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="btn-group" style="margin-top:1rem;">
                        <button type="submit" class="btn btn-primary">Save Donor</button>
                        <button type="button" class="btn btn-secondary" id="cancelDonorBtn">Cancel</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h2>Donor List</h2>
                <div class="toolbar">
                    <input type="text" class="search-box" id="donorSearch" placeholder="Search donors...">
                    <button class="btn btn-secondary" id="importDonorsCsvBtn">Import CSV</button>
                </div>
                <div class="table-container">
                    <table id="donorTable">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="name">Name</th>
                                <th class="sortable" data-sort="business">Business</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Items</th>
                                <th class="actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="donorTableBody"></tbody>
                    </table>
                </div>
                <div class="empty-state" id="donorEmptyState">
                    <div class="icon">üìã</div>
                    <p>No donors yet. Add your first donor above or import from CSV.</p>
                </div>
            </div>
        </div>

        <!-- Items Panel -->
        <div class="panel" id="panel-items">
            <div class="card">
                <h2>Add/Edit Item</h2>
                <form id="itemForm">
                    <input type="hidden" id="itemId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="itemLotNumber">Lot # *</label>
                            <input type="text" id="itemLotNumber" required>
                        </div>
                        <div class="form-group">
                            <label for="itemTitle">Title *</label>
                            <input type="text" id="itemTitle" required>
                        </div>
                        <div class="form-group">
                            <label for="itemDonor">Donor</label>
                            <select id="itemDonor">
                                <option value="">-- Select Donor --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="itemCategory">Category</label>
                            <select id="itemCategory">
                                <option value="">-- No Category --</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label for="itemDescription">Description</label>
                            <textarea id="itemDescription" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="itemFmv">Fair Market Value ($)</label>
                            <input type="number" id="itemFmv" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="itemStartingBid">Starting Bid ($)</label>
                            <input type="number" id="itemStartingBid" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="itemIncrement">Bid Increment ($)</label>
                            <input type="number" id="itemIncrement" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="itemBuyNow">Buy Now Price ($)</label>
                            <input type="number" id="itemBuyNow" min="0" step="0.01">
                            <span class="hint">Optional - instant purchase price</span>
                        </div>
                    </div>
                    <div class="btn-group" style="margin-top:1rem;">
                        <button type="submit" class="btn btn-primary">Save Item</button>
                        <button type="button" class="btn btn-secondary" id="cancelItemBtn">Cancel</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h2>Item List</h2>
                <div class="toolbar">
                    <input type="text" class="search-box" id="itemSearch" placeholder="Search items...">
                    <select id="itemCategoryFilter">
                        <option value="">All Categories</option>
                    </select>
                    <button class="btn btn-secondary" id="importItemsCsvBtn">Import CSV</button>
                    <button class="btn btn-secondary" id="autoLotNumberBtn">Auto-Number Lots</button>
                </div>
                <div class="table-container">
                    <table id="itemTable">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="lotNumber">Lot #</th>
                                <th class="sortable" data-sort="title">Title</th>
                                <th>Donor</th>
                                <th>Category</th>
                                <th class="sortable" data-sort="fmv">FMV</th>
                                <th>Starting</th>
                                <th>Status</th>
                                <th class="actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="itemTableBody"></tbody>
                    </table>
                </div>
                <div class="empty-state" id="itemEmptyState">
                    <div class="icon">üéÅ</div>
                    <p>No items yet. Add your first item above or import from CSV.</p>
                </div>
            </div>
        </div>

        <!-- Print Panel -->
        <div class="panel" id="panel-print">
            <div class="card">
                <h2>Print Options</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="printType">What to Print</label>
                        <select id="printType">
                            <option value="bidsheets">Bid Sheets</option>
                            <option value="itemlist">Item List (Price List)</option>
                            <option value="donorlist">Donor List</option>
                            <option value="thankyou">Thank-You Letters</option>
                        </select>
                    </div>
                    <div class="form-group" id="printCategoryGroup">
                        <label for="printCategory">Filter by Category</label>
                        <select id="printCategory">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                </div>
                <div class="btn-group" style="margin-top:1rem;">
                    <button class="btn btn-primary" id="previewPrintBtn">Preview</button>
                    <button class="btn btn-success" id="printBtn">Print</button>
                </div>
            </div>

            <div class="card" id="printPreview">
                <h2>Print Preview</h2>
                <div id="printPreviewContent" style="border:1px solid var(--border);padding:1rem;background:#fff;max-height:500px;overflow:auto;">
                    <p class="empty-state">Click "Preview" to see what will be printed.</p>
                </div>
            </div>
        </div>

        <!-- Checkout Panel -->
        <div class="panel" id="panel-checkout">
            <div class="stats-grid" style="margin-bottom:1.5rem;">
                <div class="stat-card">
                    <div class="label">Total Items</div>
                    <div class="value" id="statTotalItems">0</div>
                </div>
                <div class="stat-card">
                    <div class="label">Items Sold</div>
                    <div class="value" id="statItemsSold">0</div>
                </div>
                <div class="stat-card success">
                    <div class="label">Total Raised</div>
                    <div class="value" id="statTotalRaised">$0</div>
                </div>
                <div class="stat-card warning">
                    <div class="label">Paid</div>
                    <div class="value" id="statPaid">$0</div>
                </div>
                <div class="stat-card">
                    <div class="label">Outstanding</div>
                    <div class="value" id="statOutstanding">$0</div>
                </div>
            </div>

            <div class="card">
                <h2>Record Winner</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="checkoutSearch">Search Item (Lot # or Title)</label>
                        <input type="text" id="checkoutSearch" placeholder="Type lot number or title...">
                    </div>
                </div>
                <div id="checkoutSearchResults" style="margin-top:1rem;"></div>
            </div>

            <div class="card">
                <h2>Winners</h2>
                <div class="toolbar">
                    <input type="text" class="search-box" id="winnerSearch" placeholder="Search winners...">
                    <select id="winnerFilter">
                        <option value="">All</option>
                        <option value="paid">Paid</option>
                        <option value="unpaid">Unpaid</option>
                    </select>
                </div>
                <div id="winnersList"></div>
                <div class="empty-state" id="winnersEmptyState">
                    <div class="icon">üèÜ</div>
                    <p>No winners recorded yet. Use the search above to find items and record winners.</p>
                </div>
            </div>
        </div>

        <!-- Export/Import Panel -->
        <div class="panel" id="panel-export">
            <div class="card">
                <h2>Backup & Restore (JSON)</h2>
                <p style="font-size:0.9rem;color:var(--text-light);margin-bottom:1rem;">
                    Export all your data as a JSON file for backup. Import to restore data.
                </p>
                <div class="btn-group">
                    <button class="btn btn-primary" id="exportJsonBtn">Export JSON</button>
                    <button class="btn btn-secondary" id="importJsonBtn">Import JSON</button>
                    <input type="file" id="importJsonFile" accept=".json" style="display:none;">
                </div>
            </div>

            <div class="card">
                <h2>Export to CSV</h2>
                <p style="font-size:0.9rem;color:var(--text-light);margin-bottom:1rem;">
                    Export items with winner information for use in spreadsheets.
                </p>
                <div class="btn-group">
                    <button class="btn btn-secondary" id="exportItemsCsvBtn">Export Items CSV</button>
                    <button class="btn btn-secondary" id="exportDonorsCsvBtn">Export Donors CSV</button>
                    <button class="btn btn-secondary" id="exportWinnersCsvBtn">Export Winners CSV</button>
                </div>
            </div>

            <div class="card">
                <h2>Standalone HTML Archive</h2>
                <p style="font-size:0.9rem;color:var(--text-light);margin-bottom:1rem;">
                    Create a self-contained HTML file with all your data embedded. Can be opened in any browser.
                </p>
                <div class="btn-group">
                    <button class="btn btn-secondary" id="exportHtmlBtn">Export HTML Archive</button>
                </div>
            </div>

            <div class="card">
                <h2>Clear All Data</h2>
                <p style="font-size:0.9rem;color:var(--text-light);margin-bottom:1rem;">
                    Permanently delete all auction data. This cannot be undone!
                </p>
                <button class="btn btn-danger" id="clearDataBtn">Clear All Data</button>
            </div>
        </div>
    </div>

    <!-- Print Content Container -->
    <div class="print-content" id="printContainer"></div>

    <!-- CSV Import Modal -->
    <div class="modal-overlay" id="csvModal">
        <div class="modal" style="width:800px;">
            <div class="modal-header">
                <h3 id="csvModalTitle">Import CSV</h3>
                <button class="modal-close" id="closeCsvModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="csvFile">Select CSV File</label>
                    <input type="file" id="csvFile" accept=".csv,.txt">
                </div>
                <div id="csvPreview" style="margin-top:1rem;"></div>
                <div id="csvColumnMapping" style="margin-top:1rem;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelCsvImport">Cancel</button>
                <button class="btn btn-primary" id="confirmCsvImport" disabled>Import</button>
            </div>
        </div>
    </div>

    <!-- Winner Entry Modal -->
    <div class="modal-overlay" id="winnerModal">
        <div class="modal" style="width:400px;">
            <div class="modal-header">
                <h3>Record Winner</h3>
                <button class="modal-close" id="closeWinnerModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="winnerItemInfo" style="margin-bottom:1rem;padding:0.75rem;background:#f8f9fa;border-radius:4px;"></div>
                <form id="winnerForm">
                    <input type="hidden" id="winnerItemId">
                    <div class="form-group">
                        <label for="winnerName">Winner Name *</label>
                        <input type="text" id="winnerName" required>
                    </div>
                    <div class="form-group">
                        <label for="winnerPaddle">Paddle Number</label>
                        <input type="text" id="winnerPaddle">
                    </div>
                    <div class="form-group">
                        <label for="winningBid">Winning Bid ($) *</label>
                        <input type="number" id="winningBid" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="winnerPaid">
                            Paid
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelWinnerEntry">Cancel</button>
                <button class="btn btn-success" id="saveWinnerBtn">Save Winner</button>
            </div>
        </div>
    </div>

    <!-- Confirm Dialog Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal" style="width:400px;">
            <div class="modal-header">
                <h3 id="confirmTitle">Confirm</h3>
                <button class="modal-close" id="closeConfirmModal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="confirmCancel">Cancel</button>
                <button class="btn btn-danger" id="confirmOk">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // STATE MANAGEMENT
        // ============================================================
        const STORAGE_KEY = 'phdc_auction_data';
        let state = {
            settings: {
                orgName: '',
                eventName: '',
                eventDate: '',
                logo: null,
                bidSheet: {
                    lineCount: 15,
                    fontSize: 'medium',
                    showDonor: true,
                    showFmv: true,
                    showBuyNow: true,
                    footer: ''
                },
                thankYouTemplate: document.getElementById('thankYouTemplate').value
            },
            donors: [],
            items: [],
            winners: [],
            categories: []
        };

        let saveTimeout = null;

        function loadState() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    state = { ...state, ...parsed };
                }
            } catch (e) {
                console.error('Failed to load state:', e);
            }
            applyStateToUI();
        }

        function saveState() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                } catch (e) {
                    console.error('Failed to save state:', e);
                }
            }, 300);
        }

        function applyStateToUI() {
            // Settings
            document.getElementById('orgName').value = state.settings.orgName || '';
            document.getElementById('eventName').value = state.settings.eventName || '';
            document.getElementById('eventDate').value = state.settings.eventDate || '';
            document.getElementById('bidLineCount').value = state.settings.bidSheet?.lineCount || 15;
            document.getElementById('bidSheetFontSize').value = state.settings.bidSheet?.fontSize || 'medium';
            document.getElementById('showDonorOnSheet').checked = state.settings.bidSheet?.showDonor !== false;
            document.getElementById('showFmvOnSheet').checked = state.settings.bidSheet?.showFmv !== false;
            document.getElementById('showBuyNowOnSheet').checked = state.settings.bidSheet?.showBuyNow !== false;
            document.getElementById('bidSheetFooter').value = state.settings.bidSheet?.footer || '';
            document.getElementById('thankYouTemplate').value = state.settings.thankYouTemplate || '';

            // Logo
            updateLogoPreview();

            // Header info
            updateHeaderInfo();

            // Render lists
            renderCategories();
            renderDonorTable();
            renderItemTable();
            updateDonorDropdown();
            updateCategoryDropdowns();
            renderWinnersList();
            updateStats();
        }

        function updateHeaderInfo() {
            const info = [];
            if (state.settings.eventName) info.push(state.settings.eventName);
            if (state.settings.eventDate) {
                const d = new Date(state.settings.eventDate + 'T00:00:00');
                info.push(d.toLocaleDateString());
            }
            document.getElementById('headerEventInfo').textContent = info.join(' - ');
        }

        function updateLogoPreview() {
            const container = document.getElementById('logoPreview');
            const removeBtn = document.getElementById('removeLogo');
            if (state.settings.logo) {
                container.innerHTML = `<img src="${state.settings.logo}" class="logo-preview" alt="Logo">`;
                removeBtn.style.display = 'inline-block';
            } else {
                container.innerHTML = '<div class="logo-placeholder">No logo uploaded</div>';
                removeBtn.style.display = 'none';
            }
        }

        // ============================================================
        // UTILITY FUNCTIONS
        // ============================================================
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        function formatCurrency(amount) {
            if (amount === null || amount === undefined || amount === '') return '';
            return '$' + parseFloat(amount).toFixed(2);
        }

        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function getDonorName(donorId) {
            const donor = state.donors.find(d => d.id === donorId);
            if (!donor) return '';
            return donor.business || donor.name;
        }

        function getDonorItemCount(donorId) {
            return state.items.filter(i => i.donorId === donorId).length;
        }

        function getNextLotNumber() {
            const existing = state.items.map(i => parseInt(i.lotNumber) || 0);
            return existing.length > 0 ? Math.max(...existing) + 1 : 1;
        }

        // ============================================================
        // TAB NAVIGATION
        // ============================================================
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('panel-' + tab.dataset.panel).classList.add('active');
            });
        });

        // ============================================================
        // SETTINGS HANDLERS
        // ============================================================
        ['orgName', 'eventName', 'eventDate', 'bidLineCount', 'bidSheetFontSize',
         'showDonorOnSheet', 'showFmvOnSheet', 'showBuyNowOnSheet', 'bidSheetFooter', 'thankYouTemplate'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('input', () => {
                    if (id === 'orgName') state.settings.orgName = el.value;
                    else if (id === 'eventName') { state.settings.eventName = el.value; updateHeaderInfo(); }
                    else if (id === 'eventDate') { state.settings.eventDate = el.value; updateHeaderInfo(); }
                    else if (id === 'bidLineCount') state.settings.bidSheet.lineCount = parseInt(el.value) || 15;
                    else if (id === 'bidSheetFontSize') state.settings.bidSheet.fontSize = el.value;
                    else if (id === 'showDonorOnSheet') state.settings.bidSheet.showDonor = el.checked;
                    else if (id === 'showFmvOnSheet') state.settings.bidSheet.showFmv = el.checked;
                    else if (id === 'showBuyNowOnSheet') state.settings.bidSheet.showBuyNow = el.checked;
                    else if (id === 'bidSheetFooter') state.settings.bidSheet.footer = el.value;
                    else if (id === 'thankYouTemplate') state.settings.thankYouTemplate = el.value;
                    saveState();
                });
                el.addEventListener('change', () => el.dispatchEvent(new Event('input')));
            }
        });

        // Logo upload
        document.getElementById('logoUpload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    state.settings.logo = ev.target.result;
                    updateLogoPreview();
                    saveState();
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('removeLogo').addEventListener('click', () => {
            state.settings.logo = null;
            document.getElementById('logoUpload').value = '';
            updateLogoPreview();
            saveState();
        });

        // ============================================================
        // CATEGORIES
        // ============================================================
        document.getElementById('addCategoryBtn').addEventListener('click', () => {
            const input = document.getElementById('newCategory');
            const name = input.value.trim();
            if (name && !state.categories.includes(name)) {
                state.categories.push(name);
                state.categories.sort();
                input.value = '';
                renderCategories();
                updateCategoryDropdowns();
                saveState();
            }
        });

        function renderCategories() {
            const container = document.getElementById('categoryList');
            if (state.categories.length === 0) {
                container.innerHTML = '<p style="color:var(--text-light);font-size:0.9rem;">No categories defined.</p>';
                return;
            }
            container.innerHTML = state.categories.map(cat => `
                <span class="category-tag" style="margin:0.25rem;">
                    ${escapeHtml(cat)}
                    <button style="background:none;border:none;cursor:pointer;color:var(--danger);margin-left:0.25rem;"
                            onclick="removeCategory('${escapeHtml(cat)}')">&times;</button>
                </span>
            `).join('');
        }

        function removeCategory(name) {
            const itemsWithCat = state.items.filter(i => i.category === name);
            if (itemsWithCat.length > 0) {
                showConfirm(
                    'Remove Category',
                    `${itemsWithCat.length} item(s) use this category. Remove anyway? (Items will have no category)`,
                    () => {
                        state.items.forEach(i => { if (i.category === name) i.category = ''; });
                        state.categories = state.categories.filter(c => c !== name);
                        renderCategories();
                        updateCategoryDropdowns();
                        renderItemTable();
                        saveState();
                    }
                );
            } else {
                state.categories = state.categories.filter(c => c !== name);
                renderCategories();
                updateCategoryDropdowns();
                saveState();
            }
        }

        function updateCategoryDropdowns() {
            const options = '<option value="">-- No Category --</option>' +
                state.categories.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
            document.getElementById('itemCategory').innerHTML = options;
            document.getElementById('itemCategoryFilter').innerHTML = '<option value="">All Categories</option>' +
                state.categories.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
            document.getElementById('printCategory').innerHTML = '<option value="">All Categories</option>' +
                state.categories.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
        }

        // ============================================================
        // DONORS
        // ============================================================
        const donorForm = document.getElementById('donorForm');

        donorForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('donorId').value;
            const donor = {
                id: id || generateId(),
                name: document.getElementById('donorName').value.trim(),
                business: document.getElementById('donorBusiness').value.trim(),
                email: document.getElementById('donorEmail').value.trim(),
                phone: document.getElementById('donorPhone').value.trim(),
                address: document.getElementById('donorAddress').value.trim(),
                notes: document.getElementById('donorNotes').value.trim()
            };

            if (id) {
                const idx = state.donors.findIndex(d => d.id === id);
                if (idx >= 0) state.donors[idx] = donor;
            } else {
                state.donors.push(donor);
            }

            clearDonorForm();
            renderDonorTable();
            updateDonorDropdown();
            saveState();
        });

        document.getElementById('cancelDonorBtn').addEventListener('click', clearDonorForm);

        function clearDonorForm() {
            document.getElementById('donorId').value = '';
            donorForm.reset();
        }

        function editDonor(id) {
            const donor = state.donors.find(d => d.id === id);
            if (!donor) return;
            document.getElementById('donorId').value = donor.id;
            document.getElementById('donorName').value = donor.name;
            document.getElementById('donorBusiness').value = donor.business || '';
            document.getElementById('donorEmail').value = donor.email || '';
            document.getElementById('donorPhone').value = donor.phone || '';
            document.getElementById('donorAddress').value = donor.address || '';
            document.getElementById('donorNotes').value = donor.notes || '';
            document.getElementById('donorName').focus();
        }

        function deleteDonor(id) {
            const itemCount = getDonorItemCount(id);
            if (itemCount > 0) {
                showConfirm(
                    'Delete Donor',
                    `This donor has ${itemCount} item(s). Delete anyway? (Items will have no donor)`,
                    () => {
                        state.items.forEach(i => { if (i.donorId === id) i.donorId = ''; });
                        state.donors = state.donors.filter(d => d.id !== id);
                        renderDonorTable();
                        renderItemTable();
                        updateDonorDropdown();
                        saveState();
                    }
                );
            } else {
                state.donors = state.donors.filter(d => d.id !== id);
                renderDonorTable();
                updateDonorDropdown();
                saveState();
            }
        }

        function renderDonorTable() {
            const tbody = document.getElementById('donorTableBody');
            const emptyState = document.getElementById('donorEmptyState');
            const search = document.getElementById('donorSearch').value.toLowerCase();

            let donors = state.donors.filter(d => {
                if (!search) return true;
                return (d.name + ' ' + d.business + ' ' + d.email).toLowerCase().includes(search);
            });

            if (donors.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                document.getElementById('donorTable').style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';
            document.getElementById('donorTable').style.display = 'table';

            tbody.innerHTML = donors.map(d => `
                <tr>
                    <td>${escapeHtml(d.name)}</td>
                    <td>${escapeHtml(d.business)}</td>
                    <td>${escapeHtml(d.email)}</td>
                    <td>${escapeHtml(d.phone)}</td>
                    <td>${getDonorItemCount(d.id)}</td>
                    <td class="actions">
                        <button class="btn btn-sm btn-secondary" onclick="editDonor('${d.id}')">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteDonor('${d.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateDonorDropdown() {
            const select = document.getElementById('itemDonor');
            select.innerHTML = '<option value="">-- Select Donor --</option>' +
                state.donors.map(d => `<option value="${d.id}">${escapeHtml(d.business || d.name)}</option>`).join('');
        }

        document.getElementById('donorSearch').addEventListener('input', renderDonorTable);

        // ============================================================
        // ITEMS
        // ============================================================
        const itemForm = document.getElementById('itemForm');

        itemForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('itemId').value;
            const item = {
                id: id || generateId(),
                lotNumber: document.getElementById('itemLotNumber').value.trim(),
                title: document.getElementById('itemTitle').value.trim(),
                description: document.getElementById('itemDescription').value.trim(),
                donorId: document.getElementById('itemDonor').value,
                category: document.getElementById('itemCategory').value,
                fmv: parseFloat(document.getElementById('itemFmv').value) || null,
                startingBid: parseFloat(document.getElementById('itemStartingBid').value) || null,
                increment: parseFloat(document.getElementById('itemIncrement').value) || null,
                buyNow: parseFloat(document.getElementById('itemBuyNow').value) || null,
                status: 'available'
            };

            if (id) {
                const idx = state.items.findIndex(i => i.id === id);
                if (idx >= 0) {
                    item.status = state.items[idx].status;
                    state.items[idx] = item;
                }
            } else {
                state.items.push(item);
            }

            clearItemForm();
            renderItemTable();
            saveState();
        });

        document.getElementById('cancelItemBtn').addEventListener('click', clearItemForm);

        function clearItemForm() {
            document.getElementById('itemId').value = '';
            itemForm.reset();
            document.getElementById('itemLotNumber').value = getNextLotNumber();
        }

        function editItem(id) {
            const item = state.items.find(i => i.id === id);
            if (!item) return;
            document.getElementById('itemId').value = item.id;
            document.getElementById('itemLotNumber').value = item.lotNumber;
            document.getElementById('itemTitle').value = item.title;
            document.getElementById('itemDescription').value = item.description || '';
            document.getElementById('itemDonor').value = item.donorId || '';
            document.getElementById('itemCategory').value = item.category || '';
            document.getElementById('itemFmv').value = item.fmv || '';
            document.getElementById('itemStartingBid').value = item.startingBid || '';
            document.getElementById('itemIncrement').value = item.increment || '';
            document.getElementById('itemBuyNow').value = item.buyNow || '';
            document.getElementById('itemLotNumber').focus();
        }

        function deleteItem(id) {
            const winner = state.winners.find(w => w.itemId === id);
            if (winner) {
                showConfirm(
                    'Delete Item',
                    'This item has a winner recorded. Delete anyway?',
                    () => {
                        state.winners = state.winners.filter(w => w.itemId !== id);
                        state.items = state.items.filter(i => i.id !== id);
                        renderItemTable();
                        renderWinnersList();
                        updateStats();
                        saveState();
                    }
                );
            } else {
                state.items = state.items.filter(i => i.id !== id);
                renderItemTable();
                saveState();
            }
        }

        function renderItemTable() {
            const tbody = document.getElementById('itemTableBody');
            const emptyState = document.getElementById('itemEmptyState');
            const search = document.getElementById('itemSearch').value.toLowerCase();
            const catFilter = document.getElementById('itemCategoryFilter').value;

            let items = state.items.filter(i => {
                if (catFilter && i.category !== catFilter) return false;
                if (!search) return true;
                return (i.lotNumber + ' ' + i.title + ' ' + i.description).toLowerCase().includes(search);
            });

            // Sort by lot number
            items.sort((a, b) => {
                const aNum = parseInt(a.lotNumber) || 0;
                const bNum = parseInt(b.lotNumber) || 0;
                return aNum - bNum;
            });

            if (items.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                document.getElementById('itemTable').style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';
            document.getElementById('itemTable').style.display = 'table';

            tbody.innerHTML = items.map(i => {
                const winner = state.winners.find(w => w.itemId === i.id);
                let statusBadge = '<span class="badge badge-info">Available</span>';
                if (winner) {
                    statusBadge = winner.isPaid
                        ? '<span class="badge badge-success">Sold & Paid</span>'
                        : '<span class="badge badge-warning">Sold</span>';
                }
                return `
                    <tr>
                        <td><strong>${escapeHtml(i.lotNumber)}</strong></td>
                        <td>${escapeHtml(i.title)}</td>
                        <td>${escapeHtml(getDonorName(i.donorId))}</td>
                        <td>${i.category ? `<span class="category-tag">${escapeHtml(i.category)}</span>` : ''}</td>
                        <td>${formatCurrency(i.fmv)}</td>
                        <td>${formatCurrency(i.startingBid)}</td>
                        <td>${statusBadge}</td>
                        <td class="actions">
                            <button class="btn btn-sm btn-secondary" onclick="editItem('${i.id}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteItem('${i.id}')">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        document.getElementById('itemSearch').addEventListener('input', renderItemTable);
        document.getElementById('itemCategoryFilter').addEventListener('change', renderItemTable);

        document.getElementById('autoLotNumberBtn').addEventListener('click', () => {
            if (state.items.length === 0) return;
            showConfirm(
                'Auto-Number Lots',
                'This will renumber all items starting from 1. Continue?',
                () => {
                    state.items.sort((a, b) => {
                        const aNum = parseInt(a.lotNumber) || 0;
                        const bNum = parseInt(b.lotNumber) || 0;
                        return aNum - bNum;
                    });
                    state.items.forEach((item, idx) => {
                        item.lotNumber = String(idx + 1);
                    });
                    renderItemTable();
                    saveState();
                }
            );
        });

        // ============================================================
        // CSV PARSER
        // ============================================================
        function parseCSV(text) {
            const lines = [];
            let current = [];
            let field = '';
            let inQuotes = false;

            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const next = text[i + 1];

                if (inQuotes) {
                    if (char === '"' && next === '"') {
                        field += '"';
                        i++;
                    } else if (char === '"') {
                        inQuotes = false;
                    } else {
                        field += char;
                    }
                } else {
                    if (char === '"') {
                        inQuotes = true;
                    } else if (char === ',') {
                        current.push(field.trim());
                        field = '';
                    } else if (char === '\n' || (char === '\r' && next === '\n')) {
                        current.push(field.trim());
                        if (current.some(f => f)) lines.push(current);
                        current = [];
                        field = '';
                        if (char === '\r') i++;
                    } else if (char !== '\r') {
                        field += char;
                    }
                }
            }

            if (field || current.length) {
                current.push(field.trim());
                if (current.some(f => f)) lines.push(current);
            }

            return lines;
        }

        function detectColumns(headers, type) {
            const mapping = {};
            const normalized = headers.map(h => h.toLowerCase().replace(/[^a-z0-9]/g, ''));

            const patterns = type === 'donors' ? {
                name: ['name', 'contactname', 'contact', 'donorname', 'donor'],
                business: ['business', 'businessname', 'company', 'organization', 'org'],
                email: ['email', 'emailaddress', 'mail'],
                phone: ['phone', 'phonenumber', 'tel', 'telephone'],
                address: ['address', 'streetaddress', 'street'],
                notes: ['notes', 'comments', 'note']
            } : {
                lotNumber: ['lot', 'lotnumber', 'lotno', 'number', 'item'],
                title: ['title', 'name', 'itemname', 'itemtitle', 'description'],
                description: ['description', 'desc', 'details', 'info'],
                donor: ['donor', 'donorname', 'donatedby', 'business'],
                category: ['category', 'cat', 'type'],
                fmv: ['fmv', 'value', 'fairmarketvalue', 'retailvalue', 'retail'],
                startingBid: ['startingbid', 'starting', 'minbid', 'minimum', 'start'],
                increment: ['increment', 'bidincrement', 'inc'],
                buyNow: ['buynow', 'buynowprice', 'buyprice', 'instant']
            };

            for (const [field, options] of Object.entries(patterns)) {
                for (let i = 0; i < normalized.length; i++) {
                    if (options.some(opt => normalized[i].includes(opt))) {
                        mapping[field] = i;
                        break;
                    }
                }
            }

            return mapping;
        }

        // ============================================================
        // CSV IMPORT MODAL
        // ============================================================
        let csvData = null;
        let csvType = null;
        let csvMapping = null;

        document.getElementById('importDonorsCsvBtn').addEventListener('click', () => openCsvModal('donors'));
        document.getElementById('importItemsCsvBtn').addEventListener('click', () => openCsvModal('items'));

        function openCsvModal(type) {
            csvType = type;
            csvData = null;
            csvMapping = null;
            document.getElementById('csvModalTitle').textContent = `Import ${type === 'donors' ? 'Donors' : 'Items'} from CSV`;
            document.getElementById('csvFile').value = '';
            document.getElementById('csvPreview').innerHTML = '';
            document.getElementById('csvColumnMapping').innerHTML = '';
            document.getElementById('confirmCsvImport').disabled = true;
            document.getElementById('csvModal').classList.add('active');
        }

        document.getElementById('closeCsvModal').addEventListener('click', closeCsvModal);
        document.getElementById('cancelCsvImport').addEventListener('click', closeCsvModal);

        function closeCsvModal() {
            document.getElementById('csvModal').classList.remove('active');
        }

        document.getElementById('csvFile').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (ev) => {
                const text = ev.target.result;
                csvData = parseCSV(text);

                if (csvData.length < 2) {
                    document.getElementById('csvPreview').innerHTML = '<p style="color:var(--danger);">CSV must have a header row and at least one data row.</p>';
                    return;
                }

                const headers = csvData[0];
                csvMapping = detectColumns(headers, csvType);

                // Show preview table
                let previewHtml = '<p><strong>Preview (first 5 rows):</strong></p>';
                previewHtml += '<div class="table-container"><table><thead><tr>';
                headers.forEach(h => previewHtml += `<th>${escapeHtml(h)}</th>`);
                previewHtml += '</tr></thead><tbody>';
                csvData.slice(1, 6).forEach(row => {
                    previewHtml += '<tr>';
                    row.forEach(cell => previewHtml += `<td>${escapeHtml(cell)}</td>`);
                    previewHtml += '</tr>';
                });
                previewHtml += '</tbody></table></div>';
                document.getElementById('csvPreview').innerHTML = previewHtml;

                // Show column mapping
                const fields = csvType === 'donors'
                    ? ['name', 'business', 'email', 'phone', 'address', 'notes']
                    : ['lotNumber', 'title', 'description', 'donor', 'category', 'fmv', 'startingBid', 'increment', 'buyNow'];

                const fieldLabels = {
                    name: 'Contact Name*', business: 'Business', email: 'Email', phone: 'Phone',
                    address: 'Address', notes: 'Notes', lotNumber: 'Lot #*', title: 'Title*',
                    description: 'Description', donor: 'Donor', category: 'Category',
                    fmv: 'Fair Market Value', startingBid: 'Starting Bid', increment: 'Increment', buyNow: 'Buy Now'
                };

                let mappingHtml = '<p><strong>Column Mapping:</strong></p><div class="form-grid">';
                fields.forEach(field => {
                    mappingHtml += `<div class="form-group">
                        <label>${fieldLabels[field]}</label>
                        <select id="map_${field}">
                            <option value="">-- Skip --</option>
                            ${headers.map((h, i) => `<option value="${i}" ${csvMapping[field] === i ? 'selected' : ''}>${escapeHtml(h)}</option>`).join('')}
                        </select>
                    </div>`;
                });
                mappingHtml += '</div>';
                document.getElementById('csvColumnMapping').innerHTML = mappingHtml;
                document.getElementById('confirmCsvImport').disabled = false;
            };
            reader.readAsText(file);
        });

        document.getElementById('confirmCsvImport').addEventListener('click', () => {
            if (!csvData || csvData.length < 2) return;

            const headers = csvData[0];
            const mapping = {};

            if (csvType === 'donors') {
                ['name', 'business', 'email', 'phone', 'address', 'notes'].forEach(field => {
                    const val = document.getElementById('map_' + field).value;
                    if (val !== '') mapping[field] = parseInt(val);
                });

                if (mapping.name === undefined) {
                    alert('Contact Name is required.');
                    return;
                }

                let imported = 0;
                csvData.slice(1).forEach(row => {
                    const name = row[mapping.name]?.trim();
                    if (!name) return;

                    state.donors.push({
                        id: generateId(),
                        name: name,
                        business: mapping.business !== undefined ? row[mapping.business]?.trim() || '' : '',
                        email: mapping.email !== undefined ? row[mapping.email]?.trim() || '' : '',
                        phone: mapping.phone !== undefined ? row[mapping.phone]?.trim() || '' : '',
                        address: mapping.address !== undefined ? row[mapping.address]?.trim() || '' : '',
                        notes: mapping.notes !== undefined ? row[mapping.notes]?.trim() || '' : ''
                    });
                    imported++;
                });

                renderDonorTable();
                updateDonorDropdown();
                saveState();
                closeCsvModal();
                alert(`Imported ${imported} donor(s).`);
            } else {
                ['lotNumber', 'title', 'description', 'donor', 'category', 'fmv', 'startingBid', 'increment', 'buyNow'].forEach(field => {
                    const val = document.getElementById('map_' + field).value;
                    if (val !== '') mapping[field] = parseInt(val);
                });

                if (mapping.title === undefined) {
                    alert('Title is required.');
                    return;
                }

                let imported = 0;
                let lotNum = getNextLotNumber();
                const newCategories = new Set();

                csvData.slice(1).forEach(row => {
                    const title = row[mapping.title]?.trim();
                    if (!title) return;

                    // Find or create donor
                    let donorId = '';
                    if (mapping.donor !== undefined) {
                        const donorName = row[mapping.donor]?.trim();
                        if (donorName) {
                            let donor = state.donors.find(d =>
                                d.name.toLowerCase() === donorName.toLowerCase() ||
                                d.business.toLowerCase() === donorName.toLowerCase()
                            );
                            if (!donor) {
                                donor = { id: generateId(), name: donorName, business: '', email: '', phone: '', address: '', notes: '' };
                                state.donors.push(donor);
                            }
                            donorId = donor.id;
                        }
                    }

                    // Handle category
                    let category = '';
                    if (mapping.category !== undefined) {
                        category = row[mapping.category]?.trim() || '';
                        if (category && !state.categories.includes(category)) {
                            newCategories.add(category);
                        }
                    }

                    state.items.push({
                        id: generateId(),
                        lotNumber: mapping.lotNumber !== undefined ? row[mapping.lotNumber]?.trim() || String(lotNum++) : String(lotNum++),
                        title: title,
                        description: mapping.description !== undefined ? row[mapping.description]?.trim() || '' : '',
                        donorId: donorId,
                        category: category,
                        fmv: mapping.fmv !== undefined ? parseFloat(row[mapping.fmv]) || null : null,
                        startingBid: mapping.startingBid !== undefined ? parseFloat(row[mapping.startingBid]) || null : null,
                        increment: mapping.increment !== undefined ? parseFloat(row[mapping.increment]) || null : null,
                        buyNow: mapping.buyNow !== undefined ? parseFloat(row[mapping.buyNow]) || null : null,
                        status: 'available'
                    });
                    imported++;
                });

                // Add new categories
                newCategories.forEach(cat => state.categories.push(cat));
                state.categories.sort();

                renderDonorTable();
                updateDonorDropdown();
                renderCategories();
                updateCategoryDropdowns();
                renderItemTable();
                saveState();
                closeCsvModal();
                alert(`Imported ${imported} item(s).`);
            }
        });

        // ============================================================
        // PRINT SYSTEM
        // ============================================================
        document.getElementById('previewPrintBtn').addEventListener('click', generatePrintPreview);
        document.getElementById('printBtn').addEventListener('click', () => {
            generatePrintContent();
            window.print();
        });

        function generatePrintPreview() {
            const type = document.getElementById('printType').value;
            const container = document.getElementById('printPreviewContent');

            if (type === 'bidsheets') {
                container.innerHTML = generateBidSheetsHTML(true);
            } else if (type === 'itemlist') {
                container.innerHTML = generateItemListHTML();
            } else if (type === 'donorlist') {
                container.innerHTML = generateDonorListHTML();
            } else if (type === 'thankyou') {
                container.innerHTML = generateThankYouHTML(true);
            }
        }

        function generatePrintContent() {
            const type = document.getElementById('printType').value;
            const container = document.getElementById('printContainer');

            document.body.removeAttribute('data-print-mode');

            if (type === 'bidsheets') {
                document.body.setAttribute('data-print-mode', 'bidsheets');
                container.innerHTML = generateBidSheetsHTML(false);
            } else if (type === 'itemlist') {
                container.innerHTML = generateItemListHTML();
            } else if (type === 'donorlist') {
                container.innerHTML = generateDonorListHTML();
            } else if (type === 'thankyou') {
                document.body.setAttribute('data-print-mode', 'thankyou');
                container.innerHTML = generateThankYouHTML(false);
            }
        }

        function generateBidSheetsHTML(preview) {
            const catFilter = document.getElementById('printCategory').value;
            let items = state.items.filter(i => !catFilter || i.category === catFilter);
            items.sort((a, b) => (parseInt(a.lotNumber) || 0) - (parseInt(b.lotNumber) || 0));

            if (items.length === 0) return '<p class="empty-state">No items to print.</p>';

            const lineCount = state.settings.bidSheet?.lineCount || 15;
            const showDonor = state.settings.bidSheet?.showDonor !== false;
            const showFmv = state.settings.bidSheet?.showFmv !== false;
            const showBuyNow = state.settings.bidSheet?.showBuyNow !== false;
            const footer = state.settings.bidSheet?.footer || '';

            return items.map(item => {
                const donor = getDonorName(item.donorId);
                let html = `<div class="bid-sheet" style="${preview ? 'border:1px solid #ccc;margin-bottom:1rem;padding:1rem;' : ''}">`;

                // Lot corners
                html += `<div class="lot-corner top-left">#${escapeHtml(item.lotNumber)}</div>`;
                html += `<div class="lot-corner top-right">#${escapeHtml(item.lotNumber)}</div>`;
                html += `<div class="lot-corner bottom-left">#${escapeHtml(item.lotNumber)}</div>`;
                html += `<div class="lot-corner bottom-right">#${escapeHtml(item.lotNumber)}</div>`;

                // Header with logo
                html += '<div class="bid-sheet-header">';
                if (state.settings.logo) {
                    html += `<img src="${state.settings.logo}" alt="Logo">`;
                }
                html += `<h2>${escapeHtml(state.settings.orgName || '')} ${escapeHtml(state.settings.eventName || '')}</h2>`;
                html += '</div>';

                // Item info
                html += '<div class="bid-sheet-item">';
                html += `<h3>${escapeHtml(item.title)}</h3>`;
                if (item.description) html += `<div class="description">${escapeHtml(item.description)}</div>`;
                if (showDonor && donor) html += `<div class="donor">Donated by: ${escapeHtml(donor)}</div>`;

                let valueInfo = [];
                if (showFmv && item.fmv) valueInfo.push(`Value: ${formatCurrency(item.fmv)}`);
                if (item.startingBid) valueInfo.push(`Starting Bid: ${formatCurrency(item.startingBid)}`);
                if (item.increment) valueInfo.push(`Increment: ${formatCurrency(item.increment)}`);
                if (showBuyNow && item.buyNow) valueInfo.push(`Buy Now: ${formatCurrency(item.buyNow)}`);
                if (valueInfo.length) html += `<div class="value-info">${valueInfo.join(' | ')}</div>`;

                html += '</div>';

                // Bid table
                html += '<table class="bid-table"><thead><tr><th>Bidder Name/Paddle</th><th>Bid Amount</th></tr></thead><tbody>';
                // First row with starting bid
                if (item.startingBid) {
                    html += `<tr><td>&nbsp;</td><td>${formatCurrency(item.startingBid)}</td></tr>`;
                }
                for (let i = 0; i < lineCount; i++) {
                    html += '<tr><td>&nbsp;</td><td>&nbsp;</td></tr>';
                }
                html += '</tbody></table>';

                if (footer) {
                    html += `<div class="bid-sheet-footer">${escapeHtml(footer)}</div>`;
                }

                html += '</div>';
                return html;
            }).join('');
        }

        function generateItemListHTML() {
            const catFilter = document.getElementById('printCategory').value;
            let items = state.items.filter(i => !catFilter || i.category === catFilter);
            items.sort((a, b) => (parseInt(a.lotNumber) || 0) - (parseInt(b.lotNumber) || 0));

            if (items.length === 0) return '<p class="empty-state">No items to print.</p>';

            let html = '<div style="padding:1rem;">';
            html += `<h2 style="text-align:center;">${escapeHtml(state.settings.orgName || '')} ${escapeHtml(state.settings.eventName || '')} - Item List</h2>`;
            html += '<table style="width:100%;border-collapse:collapse;font-size:0.9rem;"><thead><tr>';
            html += '<th style="border:1px solid #333;padding:0.5rem;">Lot #</th>';
            html += '<th style="border:1px solid #333;padding:0.5rem;">Item</th>';
            html += '<th style="border:1px solid #333;padding:0.5rem;">Donor</th>';
            html += '<th style="border:1px solid #333;padding:0.5rem;">Value</th>';
            html += '<th style="border:1px solid #333;padding:0.5rem;">Starting Bid</th>';
            html += '</tr></thead><tbody>';

            items.forEach(item => {
                html += '<tr>';
                html += `<td style="border:1px solid #333;padding:0.5rem;text-align:center;">${escapeHtml(item.lotNumber)}</td>`;
                html += `<td style="border:1px solid #333;padding:0.5rem;">${escapeHtml(item.title)}</td>`;
                html += `<td style="border:1px solid #333;padding:0.5rem;">${escapeHtml(getDonorName(item.donorId))}</td>`;
                html += `<td style="border:1px solid #333;padding:0.5rem;text-align:right;">${formatCurrency(item.fmv)}</td>`;
                html += `<td style="border:1px solid #333;padding:0.5rem;text-align:right;">${formatCurrency(item.startingBid)}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            return html;
        }

        function generateDonorListHTML() {
            if (state.donors.length === 0) return '<p class="empty-state">No donors to print.</p>';

            const donorsCopy = [...state.donors].sort((a, b) => (a.business || a.name).localeCompare(b.business || b.name));

            let html = '<div style="padding:1rem;">';
            html += `<h2 style="text-align:center;">${escapeHtml(state.settings.orgName || '')} ${escapeHtml(state.settings.eventName || '')} - Donors</h2>`;
            html += '<table style="width:100%;border-collapse:collapse;font-size:0.9rem;"><thead><tr>';
            html += '<th style="border:1px solid #333;padding:0.5rem;">Business/Name</th>';
            html += '<th style="border:1px solid #333;padding:0.5rem;">Contact</th>';
            html += '<th style="border:1px solid #333;padding:0.5rem;">Email</th>';
            html += '<th style="border:1px solid #333;padding:0.5rem;">Phone</th>';
            html += '<th style="border:1px solid #333;padding:0.5rem;">Items Donated</th>';
            html += '</tr></thead><tbody>';

            donorsCopy.forEach(donor => {
                const items = state.items.filter(i => i.donorId === donor.id);
                html += '<tr>';
                html += `<td style="border:1px solid #333;padding:0.5rem;">${escapeHtml(donor.business || donor.name)}</td>`;
                html += `<td style="border:1px solid #333;padding:0.5rem;">${donor.business ? escapeHtml(donor.name) : ''}</td>`;
                html += `<td style="border:1px solid #333;padding:0.5rem;">${escapeHtml(donor.email)}</td>`;
                html += `<td style="border:1px solid #333;padding:0.5rem;">${escapeHtml(donor.phone)}</td>`;
                html += `<td style="border:1px solid #333;padding:0.5rem;">${items.map(i => escapeHtml(i.title)).join(', ')}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            return html;
        }

        function generateThankYouHTML(preview) {
            // Group items by donor
            const donorItems = {};
            state.items.forEach(item => {
                if (item.donorId) {
                    if (!donorItems[item.donorId]) donorItems[item.donorId] = [];
                    donorItems[item.donorId].push(item);
                }
            });

            const donorIds = Object.keys(donorItems);
            if (donorIds.length === 0) return '<p class="empty-state">No donors with items to generate letters for.</p>';

            const template = state.settings.thankYouTemplate || '';
            const eventDate = state.settings.eventDate
                ? new Date(state.settings.eventDate + 'T00:00:00').toLocaleDateString()
                : '';

            return donorIds.map(donorId => {
                const donor = state.donors.find(d => d.id === donorId);
                if (!donor) return '';

                const items = donorItems[donorId];
                const itemList = items.map(i => `- ${i.title}${i.fmv ? ` (Value: ${formatCurrency(i.fmv)})` : ''}`).join('\n');
                const totalValue = items.reduce((sum, i) => sum + (i.fmv || 0), 0);

                let letter = template
                    .replace(/{DONOR_NAME}/g, donor.name)
                    .replace(/{DONOR_BUSINESS}/g, donor.business || donor.name)
                    .replace(/{ORG_NAME}/g, state.settings.orgName || '')
                    .replace(/{EVENT_NAME}/g, state.settings.eventName || '')
                    .replace(/{EVENT_DATE}/g, eventDate)
                    .replace(/{ITEM_LIST}/g, itemList)
                    .replace(/{TOTAL_VALUE}/g, formatCurrency(totalValue));

                const style = preview ? 'border:1px solid #ccc;margin-bottom:1rem;padding:1rem;white-space:pre-wrap;' : 'white-space:pre-wrap;';
                return `<div class="thank-you-letter" style="${style}">${escapeHtml(letter)}</div>`;
            }).join('');
        }

        // ============================================================
        // CHECKOUT
        // ============================================================
        document.getElementById('checkoutSearch').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase().trim();
            const container = document.getElementById('checkoutSearchResults');

            if (!query) {
                container.innerHTML = '';
                return;
            }

            const matches = state.items.filter(i => {
                const hasWinner = state.winners.some(w => w.itemId === i.id);
                if (hasWinner) return false; // Skip items that already have winners
                return i.lotNumber.toLowerCase().includes(query) || i.title.toLowerCase().includes(query);
            }).slice(0, 10);

            if (matches.length === 0) {
                container.innerHTML = '<p style="color:var(--text-light);">No matching available items found.</p>';
                return;
            }

            container.innerHTML = matches.map(item => `
                <div class="checkout-item" style="cursor:pointer;" onclick="openWinnerModal('${item.id}')">
                    <div class="lot">#${escapeHtml(item.lotNumber)}</div>
                    <div class="details">
                        <div class="title">${escapeHtml(item.title)}</div>
                        <div class="meta">${escapeHtml(getDonorName(item.donorId))} | Starting: ${formatCurrency(item.startingBid)}</div>
                    </div>
                </div>
            `).join('');
        });

        function openWinnerModal(itemId) {
            const item = state.items.find(i => i.id === itemId);
            if (!item) return;

            document.getElementById('winnerItemId').value = itemId;
            document.getElementById('winnerItemInfo').innerHTML = `
                <strong>#${escapeHtml(item.lotNumber)}: ${escapeHtml(item.title)}</strong><br>
                Starting Bid: ${formatCurrency(item.startingBid)} | Value: ${formatCurrency(item.fmv)}
            `;
            document.getElementById('winnerName').value = '';
            document.getElementById('winnerPaddle').value = '';
            document.getElementById('winningBid').value = item.startingBid || '';
            document.getElementById('winnerPaid').checked = false;
            document.getElementById('winnerModal').classList.add('active');
            document.getElementById('winnerName').focus();
        }

        document.getElementById('closeWinnerModal').addEventListener('click', () => {
            document.getElementById('winnerModal').classList.remove('active');
        });
        document.getElementById('cancelWinnerEntry').addEventListener('click', () => {
            document.getElementById('winnerModal').classList.remove('active');
        });

        document.getElementById('saveWinnerBtn').addEventListener('click', () => {
            const itemId = document.getElementById('winnerItemId').value;
            const name = document.getElementById('winnerName').value.trim();
            const bid = parseFloat(document.getElementById('winningBid').value);

            if (!name) {
                alert('Winner name is required.');
                return;
            }
            if (!bid || bid <= 0) {
                alert('Winning bid is required.');
                return;
            }

            // Remove existing winner for this item if any
            state.winners = state.winners.filter(w => w.itemId !== itemId);

            state.winners.push({
                id: generateId(),
                itemId: itemId,
                winnerName: name,
                paddleNumber: document.getElementById('winnerPaddle').value.trim(),
                winningBid: bid,
                isPaid: document.getElementById('winnerPaid').checked
            });

            // Update item status
            const item = state.items.find(i => i.id === itemId);
            if (item) item.status = 'sold';

            document.getElementById('winnerModal').classList.remove('active');
            document.getElementById('checkoutSearch').value = '';
            document.getElementById('checkoutSearchResults').innerHTML = '';
            renderWinnersList();
            renderItemTable();
            updateStats();
            saveState();
        });

        function renderWinnersList() {
            const container = document.getElementById('winnersList');
            const emptyState = document.getElementById('winnersEmptyState');
            const search = document.getElementById('winnerSearch').value.toLowerCase();
            const filter = document.getElementById('winnerFilter').value;

            let winners = state.winners.filter(w => {
                if (filter === 'paid' && !w.isPaid) return false;
                if (filter === 'unpaid' && w.isPaid) return false;
                if (search) {
                    const item = state.items.find(i => i.id === w.itemId);
                    const searchStr = (w.winnerName + ' ' + w.paddleNumber + ' ' + (item?.title || '') + ' ' + (item?.lotNumber || '')).toLowerCase();
                    if (!searchStr.includes(search)) return false;
                }
                return true;
            });

            if (winners.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            // Sort by lot number
            winners.sort((a, b) => {
                const itemA = state.items.find(i => i.id === a.itemId);
                const itemB = state.items.find(i => i.id === b.itemId);
                return (parseInt(itemA?.lotNumber) || 0) - (parseInt(itemB?.lotNumber) || 0);
            });

            container.innerHTML = winners.map(w => {
                const item = state.items.find(i => i.id === w.itemId);
                return `
                    <div class="checkout-item ${w.isPaid ? 'paid' : ''}">
                        <div class="lot">#${escapeHtml(item?.lotNumber || '?')}</div>
                        <div class="details">
                            <div class="title">${escapeHtml(item?.title || 'Unknown Item')}</div>
                            <div class="meta">Winner: ${escapeHtml(w.winnerName)} ${w.paddleNumber ? `(#${escapeHtml(w.paddleNumber)})` : ''}</div>
                        </div>
                        <div class="bid-info">
                            <div style="font-size:1.25rem;font-weight:700;">${formatCurrency(w.winningBid)}</div>
                            <div style="margin-top:0.25rem;">
                                <button class="btn btn-sm ${w.isPaid ? 'btn-success' : 'btn-secondary'}" onclick="togglePaid('${w.id}')">
                                    ${w.isPaid ? 'Paid' : 'Mark Paid'}
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="removeWinner('${w.id}')">Remove</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function togglePaid(winnerId) {
            const winner = state.winners.find(w => w.id === winnerId);
            if (winner) {
                winner.isPaid = !winner.isPaid;
                renderWinnersList();
                updateStats();
                saveState();
            }
        }

        function removeWinner(winnerId) {
            const winner = state.winners.find(w => w.id === winnerId);
            if (winner) {
                const item = state.items.find(i => i.id === winner.itemId);
                if (item) item.status = 'available';
            }
            state.winners = state.winners.filter(w => w.id !== winnerId);
            renderWinnersList();
            renderItemTable();
            updateStats();
            saveState();
        }

        document.getElementById('winnerSearch').addEventListener('input', renderWinnersList);
        document.getElementById('winnerFilter').addEventListener('change', renderWinnersList);

        function updateStats() {
            const totalItems = state.items.length;
            const itemsSold = state.winners.length;
            const totalRaised = state.winners.reduce((sum, w) => sum + (w.winningBid || 0), 0);
            const paid = state.winners.filter(w => w.isPaid).reduce((sum, w) => sum + (w.winningBid || 0), 0);
            const outstanding = totalRaised - paid;

            document.getElementById('statTotalItems').textContent = totalItems;
            document.getElementById('statItemsSold').textContent = itemsSold;
            document.getElementById('statTotalRaised').textContent = formatCurrency(totalRaised);
            document.getElementById('statPaid').textContent = formatCurrency(paid);
            document.getElementById('statOutstanding').textContent = formatCurrency(outstanding);
        }

        // ============================================================
        // EXPORT/IMPORT
        // ============================================================
        document.getElementById('exportJsonBtn').addEventListener('click', () => {
            const data = JSON.stringify(state, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            downloadBlob(blob, `auction-backup-${new Date().toISOString().slice(0,10)}.json`);
        });

        document.getElementById('importJsonBtn').addEventListener('click', () => {
            document.getElementById('importJsonFile').click();
        });

        document.getElementById('importJsonFile').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const imported = JSON.parse(ev.target.result);
                    if (imported.settings && imported.donors && imported.items) {
                        showConfirm(
                            'Import Data',
                            'This will replace all current data. Continue?',
                            () => {
                                state = { ...state, ...imported };
                                applyStateToUI();
                                saveState();
                                alert('Data imported successfully.');
                            }
                        );
                    } else {
                        alert('Invalid backup file format.');
                    }
                } catch (err) {
                    alert('Failed to parse JSON file: ' + err.message);
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        });

        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function generateCSV(headers, rows) {
            const escape = (val) => {
                if (val === null || val === undefined) return '';
                const str = String(val);
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    return '"' + str.replace(/"/g, '""') + '"';
                }
                return str;
            };
            return [headers.map(escape).join(','), ...rows.map(row => row.map(escape).join(','))].join('\n');
        }

        document.getElementById('exportItemsCsvBtn').addEventListener('click', () => {
            const headers = ['Lot #', 'Title', 'Description', 'Donor', 'Category', 'FMV', 'Starting Bid', 'Increment', 'Buy Now', 'Winner', 'Winning Bid', 'Paid'];
            const rows = state.items.map(item => {
                const winner = state.winners.find(w => w.itemId === item.id);
                return [
                    item.lotNumber,
                    item.title,
                    item.description,
                    getDonorName(item.donorId),
                    item.category,
                    item.fmv,
                    item.startingBid,
                    item.increment,
                    item.buyNow,
                    winner?.winnerName || '',
                    winner?.winningBid || '',
                    winner?.isPaid ? 'Yes' : ''
                ];
            });
            const csv = generateCSV(headers, rows);
            downloadBlob(new Blob([csv], { type: 'text/csv' }), 'auction-items.csv');
        });

        document.getElementById('exportDonorsCsvBtn').addEventListener('click', () => {
            const headers = ['Name', 'Business', 'Email', 'Phone', 'Address', 'Notes', 'Item Count'];
            const rows = state.donors.map(d => [
                d.name, d.business, d.email, d.phone, d.address, d.notes, getDonorItemCount(d.id)
            ]);
            const csv = generateCSV(headers, rows);
            downloadBlob(new Blob([csv], { type: 'text/csv' }), 'auction-donors.csv');
        });

        document.getElementById('exportWinnersCsvBtn').addEventListener('click', () => {
            const headers = ['Lot #', 'Item', 'Winner Name', 'Paddle', 'Winning Bid', 'Paid'];
            const rows = state.winners.map(w => {
                const item = state.items.find(i => i.id === w.itemId);
                return [
                    item?.lotNumber || '',
                    item?.title || '',
                    w.winnerName,
                    w.paddleNumber,
                    w.winningBid,
                    w.isPaid ? 'Yes' : 'No'
                ];
            });
            const csv = generateCSV(headers, rows);
            downloadBlob(new Blob([csv], { type: 'text/csv' }), 'auction-winners.csv');
        });

        document.getElementById('exportHtmlBtn').addEventListener('click', () => {
            const htmlContent = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>${escapeHtml(state.settings.orgName)} ${escapeHtml(state.settings.eventName)} - Auction Archive</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; padding: 2rem; max-width: 1000px; margin: 0 auto; }
        h1 { color: #330066; }
        h2 { color: #330066; border-bottom: 2px solid #330066; padding-bottom: 0.5rem; }
        table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        th, td { border: 1px solid #ddd; padding: 0.5rem; text-align: left; }
        th { background: #f1f3f4; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin: 1rem 0; }
        .stat { background: #330066; color: white; padding: 1rem; border-radius: 8px; text-align: center; }
        .stat .label { font-size: 0.8rem; }
        .stat .value { font-size: 1.5rem; font-weight: bold; }
    </style>
</head>
<body>
    <h1>${escapeHtml(state.settings.orgName)} - ${escapeHtml(state.settings.eventName)}</h1>
    <p>Date: ${state.settings.eventDate ? new Date(state.settings.eventDate + 'T00:00:00').toLocaleDateString() : 'N/A'}</p>

    <div class="stats">
        <div class="stat"><div class="label">Total Items</div><div class="value">${state.items.length}</div></div>
        <div class="stat"><div class="label">Items Sold</div><div class="value">${state.winners.length}</div></div>
        <div class="stat"><div class="label">Total Raised</div><div class="value">${formatCurrency(state.winners.reduce((s,w) => s + w.winningBid, 0))}</div></div>
    </div>

    <h2>Items</h2>
    <table>
        <thead><tr><th>Lot #</th><th>Title</th><th>Donor</th><th>FMV</th><th>Winner</th><th>Winning Bid</th></tr></thead>
        <tbody>
            ${state.items.map(item => {
                const winner = state.winners.find(w => w.itemId === item.id);
                return `<tr><td>${escapeHtml(item.lotNumber)}</td><td>${escapeHtml(item.title)}</td><td>${escapeHtml(getDonorName(item.donorId))}</td><td>${formatCurrency(item.fmv)}</td><td>${escapeHtml(winner?.winnerName || '')}</td><td>${formatCurrency(winner?.winningBid)}</td></tr>`;
            }).join('')}
        </tbody>
    </table>

    <h2>Donors</h2>
    <table>
        <thead><tr><th>Name</th><th>Business</th><th>Email</th><th>Items Donated</th></tr></thead>
        <tbody>
            ${state.donors.map(d => `<tr><td>${escapeHtml(d.name)}</td><td>${escapeHtml(d.business)}</td><td>${escapeHtml(d.email)}</td><td>${getDonorItemCount(d.id)}</td></tr>`).join('')}
        </tbody>
    </table>

    <hr>
    <p><small>Generated: ${new Date().toLocaleString()}</small></p>
    <scr` + `ipt>
        // Embedded data for potential future use
        const auctionData = ${JSON.stringify(state)};
    </scr` + `ipt>
</body>
</html>`;
            downloadBlob(new Blob([htmlContent], { type: 'text/html' }), `auction-archive-${new Date().toISOString().slice(0,10)}.html`);
        });

        document.getElementById('clearDataBtn').addEventListener('click', () => {
            showConfirm(
                'Clear All Data',
                'This will permanently delete all donors, items, winners, and settings. This cannot be undone!',
                () => {
                    localStorage.removeItem(STORAGE_KEY);
                    state = {
                        settings: {
                            orgName: '',
                            eventName: '',
                            eventDate: '',
                            logo: null,
                            bidSheet: { lineCount: 15, fontSize: 'medium', showDonor: true, showFmv: true, showBuyNow: true, footer: '' },
                            thankYouTemplate: document.getElementById('thankYouTemplate').defaultValue
                        },
                        donors: [],
                        items: [],
                        winners: [],
                        categories: []
                    };
                    applyStateToUI();
                    alert('All data has been cleared.');
                }
            );
        });

        // ============================================================
        // CONFIRM DIALOG
        // ============================================================
        let confirmCallback = null;

        function showConfirm(title, message, onConfirm) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            confirmCallback = onConfirm;
            document.getElementById('confirmModal').classList.add('active');
        }

        document.getElementById('closeConfirmModal').addEventListener('click', () => {
            document.getElementById('confirmModal').classList.remove('active');
        });
        document.getElementById('confirmCancel').addEventListener('click', () => {
            document.getElementById('confirmModal').classList.remove('active');
        });
        document.getElementById('confirmOk').addEventListener('click', () => {
            document.getElementById('confirmModal').classList.remove('active');
            if (confirmCallback) confirmCallback();
        });

        // ============================================================
        // INITIALIZATION
        // ============================================================
        loadState();
        document.getElementById('itemLotNumber').value = getNextLotNumber();
    </script>
</body>
</html>
